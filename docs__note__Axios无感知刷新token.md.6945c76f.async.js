(self["webpackChunkblog"]=self["webpackChunkblog"]||[]).push([[4685],{22116:function(e,n,t){"use strict";t.r(n);var o=t(67294),s=t(96089),r=t(65659),a=o.memo((e=>{e.demos;return o.createElement(o.Fragment,null,o.createElement("div",{className:"markdown"},o.createElement("h3",{id:"\u9879\u76ee\u80cc\u666f"},o.createElement(s.AnchorLink,{to:"#\u9879\u76ee\u80cc\u666f","aria-hidden":"true",tabIndex:-1},o.createElement("span",{className:"icon icon-link"})),"\u9879\u76ee\u80cc\u666f"),o.createElement("p",null,"\u7528\u6237\u9700\u8981\u767b\u5f55\u540e\u624d\u80fd\u6b63\u5e38\u8bbf\u95ee\u9875\u9762\u3002"),o.createElement("p",null,"\u5f53\u7528\u6237\u767b\u5f55\u6210\u529f\u540e\uff0c\u540e\u7aef\u63a5\u53e3\u4f1a\u8fd4\u7ed9\u524d\u7aef\u4e00\u4e2atoken\uff0c\u4e4b\u540e\u7684\u6bcf\u4e00\u6b21\u63a5\u53e3\u8c03\u7528\u90fd\u9700\u8981\u643a\u5e26token\uff0c\u670d\u52a1\u7aef\u9a8c\u8bc1\u8fd9\u4e2atoken\u6765\u5224\u65ad\u7528\u6237\u662f\u5426\u5df2\u7ecf\u6210\u529f\u767b\u5f55\u3002"),o.createElement("p",null,"\u5f53\u7136token\u662f\u7531\u65f6\u6548\u6027\u7684\uff0c\u5f53token\u8fc7\u671f\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u767b\u5f55\u6765\u83b7\u53d6\u65b0\u7684token\uff0c\u4f46\u8fd9\u6837\u505a\u4f53\u9a8c\u4f1a\u5f88\u5dee\uff0c\u6240\u4ee5\u8981\u6c42\u6211\u4eec\u5229\u7528\u65e7\u7684token\u53bb\u6362\u53d6\u65b0\u7684token\u3002\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u8981\u8c03\u7528\u4e00\u4e2a\u5237\u65b0token\u7684\u63a5\u53e3\uff0c\u5c06\u4e4b\u524d\u7684token\u4f20\u7ed9\u670d\u52a1\u7aef\u6765\u6362\u53d6\u6700\u65b0\u7684token\uff0c\u6709\u4e86\u6700\u65b0\u7684token\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u6b21\u8c03\u7528\u4e4b\u524d\u56e0\u4e3atoken\u8fc7\u671f\u8fd4\u56de\u72b6\u6001\u63a5\u53e3\uff0c\u8fd9\u6837\u5c31\u505a\u5230\u7528\u6237\u65e0\u611f\u77e5\u5237\u65b0token\u4e86\u3002"),o.createElement("h3",{id:"\u65b9\u6848\u8ba8\u8bba"},o.createElement(s.AnchorLink,{to:"#\u65b9\u6848\u8ba8\u8bba","aria-hidden":"true",tabIndex:-1},o.createElement("span",{className:"icon icon-link"})),"\u65b9\u6848\u8ba8\u8bba"),o.createElement("p",null,"\u5229\u7528",o.createElement("code",null,"axios"),"\u4e2d\u7684",o.createElement("code",null,"axios.interceptors.response.use()"),"\u63a5\u53e3\u8bf7\u6c42\u540e\u62e6\u622a\uff0c\u5f53token\u8fc7\u671f\u65f6\uff0c\u6211\u4eec\u901a\u8fc7\u8c03\u7528\u5237\u65b0token\u65b9\u6cd5\u83b7\u53d6\u6700\u65b0\u7684token\u4e4b\u540e\uff0c\u643a\u5e26\u6700\u65b0\u7684token\u518d\u91cd\u65b0\u8fdb\u884c\u4e00\u6b21\u8bf7\u6c42\u3002\u4e00\u822c\u4e00\u4e2a\u9875\u9762\u7684\u5c55\u793a\u6570\u636e\u90fd\u9700\u8981\u8c03\u7528\u591a\u4e2a\u63a5\u53e3\uff0c\u5982\u679ctoken\u8fc7\u671f\u4e86\uff0c\u6bcf\u4e2a\u63a5\u53e3\u90fd\u8c03\u7528\u4e00\u904d\u5237\u65b0token\uff0c\u8fd9\u6837\u52bf\u5fc5\u4f1a\u9020\u6210\u8d44\u6e90\u6d6a\u8d39\uff0c\u6211\u4eec\u5e0c\u671b\u7684\u662f\u5982\u679ctoken\u8fc7\u671f\u4e86\uff0c\u6211\u4eec\u53ea\u8c03\u7528\u4e00\u6b21\u5237\u65b0token\u63a5\u53e3\u3002\u8fd9\u91cc\u6211\u7684\u89e3\u51b3\u65b9\u6848\u662f\u5b9a\u4e49\u4e00\u4e2a",o.createElement("code",null,"let isRefreshing = false;"),"\u6807\u7b7e\u53d8\u91cf\uff0c\u6807\u8bb0\u5f53\u524d\u662f\u5426\u6b63\u5728\u5237\u65b0token\u7684\u72b6\u6001\uff0c\u5982\u679c\u6b63\u5728\u5237\u65b0\u5219\u4e0d\u518d\u8c03\u7528\u5237\u65b0token\u7684\u63a5\u53e3\u3002\u8fd9\u91cc\u8fd8\u6709\u4e00\u4e2a\u96be\u70b9\u9700\u8981\u89e3\u51b3\uff0c\u5c31\u662f\u591a\u4e2a\u63a5\u53e3\u540c\u65f6\u53d1\u8d77\u8bf7\u6c42\u65f6\uff0c\u5047\u8bbe\u7b2c\u4e00\u4e2a\u63a5\u53e3\u5148\u8fdb\u5165\uff0c\u63a5\u7740\u6267\u884c\u5237\u65b0token\u63a5\u53e3\uff0c\u56e0\u4e3a\u6807\u7b7e\u53d8\u91cf\u7684\u539f\u56e0\uff0c\u5176\u5b83\u63a5\u53e3\u4e0d\u4f1a\u6267\u884c\u5237\u65b0token\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5269\u4e0b\u7684\u63a5\u53e3\u653e\u5165\u5230\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u5f53\u5237\u65b0token\u63a5\u53e3\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\uff0c\u518d\u4f9d\u6b21\u6267\u884c\u88ab\u653e\u5165\u5230\u961f\u5217\u4e2d\u7684\u63a5\u53e3\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u7528\u5230",o.createElement("code",null,"Promise"),"\u5c06\u6240\u6709\u672a\u6267\u884c\u7684",o.createElement("code",null,"resolve"),"\u653e\u5165\u5230\u4e00\u4e2a\u6570\u7ec4\u4e2d\uff0c\u6570\u7ec4\u4e2d\u6bcf\u4e00\u4e2a\u5143\u7d20\u90fd\u5904\u4e8e",o.createElement("code",null,"pending"),"\u72b6\u6001\uff0c\u5f53\u5237\u65b0\u8bf7\u6c42\u7684\u63a5\u53e3\u8fd4\u56de\u6765\u540e\uff0c\u6211\u4eec\u518d\u8c03\u7528resolve\uff0c\u9010\u4e2a\u91ca\u653e\u3002"),o.createElement("h3",{id:"\u5b9e\u73b0"},o.createElement(s.AnchorLink,{to:"#\u5b9e\u73b0","aria-hidden":"true",tabIndex:-1},o.createElement("span",{className:"icon icon-link"})),"\u5b9e\u73b0"),o.createElement("p",null,"\u521b\u5efa\u4e86\u4e00\u4e2a",o.createElement("code",null,"localStorage.js"),"\u6587\u4ef6\uff0c\u7528\u4e8e\u5c01\u88c5js\u7684\u672c\u5730\u5b58\u50a8\uff0c\u6211\u4eec\u8981\u5c06\u4ece\u670d\u52a1\u7aef\u83b7\u53d6\u7684token\u5b58\u5230\u6d4f\u89c8\u5668\u7f13\u5b58\u4e2d\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),o.createElement(r.Z,{code:"export default {\n  //\u672c\u5730\u5b58\u50a8\u5c01\u88c5\n  get(key){\n    let data=localStorage.getItem(key);\n    return JSON.parse(data)\n  },\n  set(key,val){\n    let value=JSON.stringify(val);\n    localStorage.setItem(key,value);\n  }\n  }",lang:"js"}),o.createElement("p",null,"\u521b\u5efa\u4e86\u4e00\u4e2a",o.createElement("code",null,"service.js"),"\u6587\u4ef6\uff0c\u7528\u4e8e\u5c01\u88c5",o.createElement("code",null,"axios"),"\u8fd8\u6709\u5237\u65b0token\u7684\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),o.createElement(r.Z,{code:'import axios from "axios"; //\u5f15\u5165axios\n  import qs from "qs";//\u5e8f\u5217\u5316post\u63a5\u53e3\u8bf7\u6c42\u53c2\u6570\n  import LocalStorage from "./localStorage.js"; //H5\u672c\u5730\u5b58\u50a8\u5c01\u88c5\u65b9\u6cd5\n  let SECURITY_URL = "http://192.168.1.17:5505/security-amass/";//\u5237\u65b0token\u63a5\u53e3\u7684base\u8def\u5f84\n  axios.defaults.headers.post["Content-Type"] ="application/x-www-form-urlencoded;charset=UTF-8";\n  axios.defaults.headers.post["Access-Control-Allow-Origin"] = "*";\n  axios.defaults.withCredentials = false; // \u643a\u5e26cookie\n  // \u521b\u5efa\u4e00\u4e2aaxios\u5b9e\u4f8b\n  const instance = axios.create({\n    timeout: 300000,\n  });\n  // \u662f\u5426\u6b63\u5728\u8bf7\u6c42\u5237\u65b0token\u63a5\u53e3\u7684\u6807\u8bb0\n  let isRefreshing = false;\n  // \u8bf7\u6c42\u961f\u5217\n  let requests = [];\n  //\u5237\u65b0token\u65b9\u6cd5\n  function refreshToken(params) {\n    return instance.get(SECURITY_URL + "oauth/token", params);\n  }\n  //\u8bf7\u6c42\u7ed3\u679c\u62e6\u622a\u5668\n  instance.interceptors.response.use(\n    (response) => {\n      // \u63a5\u4e0b\u6765\u4f1a\u5728\u8fd9\u91cc\u8fdb\u884ctoken\u8fc7\u671f\u7684\u903b\u8f91\u5904\u7406\n      const config = response.config;\n      let code = response.data.code;\n      //\u8fd9\u91cc\u7684code\u503c\u662f\u8ddf\u540e\u7aef\u7ea6\u5b9a\u597d\u7684\uff0c 40009\u4ee3\u8868token\u5df2\u7ecf\u8fc7\u671f\n      if (code == "40009") {\n        if (!isRefreshing) {\n          isRefreshing = true;\n          let refresh_token = LocalStorage.get("refresh_token");\n          //\u8fd9\u91cc\u662f\u6211\u7684\u9879\u76ee\u4e2d\u5237\u65b0token\u8981\u4f20\u7684\u53c2\u6570\uff0c\u5177\u4f53\u90fd\u4f20\u90a3\u4e9b\u53c2\u6570\u9700\u8981\u4e0e\u540e\u7aef\u5f00\u53d1\u786e\u8ba4\n          let loginData = {\n            grant_type: "refresh_token",\n            client_id: "impawning",\n            client_secret: "impawning",\n            refresh_token,\n          };\n          refreshToken({ params: loginData })\n            .then((res) => {\n              let access_token = res.data.access_token;\n              let refresh_token = res.data.refresh_token;\n              LocalStorage.set("access_token", res.data.access_token);\n              LocalStorage.set("refresh_token", res.data.refresh_token);\n              config.headers["access_token"] = access_token;\n              config.headers["refresh_token"] = refresh_token;\n              requests.forEach((cb) => cb(access_token, refresh_token));\n              requests = [];\n              return instance(config);\n            })\n            .catch((err) => {\n              window.location.href = "/";\n            })\n            .finally(() => {\n              isRefreshing = false;\n            });\n        } else {\n          // \u6b63\u5728\u5237\u65b0token\uff0c\u8fd4\u56de\u4e00\u4e2a\u672a\u6267\u884cresolve\u7684promise\n          return new Promise((resolve) => {\n            // \u5c06resolve\u653e\u8fdb\u961f\u5217\uff0c\u7528\u4e00\u4e2a\u51fd\u6570\u5f62\u5f0f\u6765\u4fdd\u5b58\uff0c\u7b49token\u5237\u65b0\u540e\u76f4\u63a5\u6267\u884c\n            requests.push((access_token, refresh_token) => {\n              config.headers["access_token"] = access_token;\n              config.headers["refresh_token"] = refresh_token;\n              resolve(instance(config));\n            });\n          });\n        }\n      } else if (code == "40005" || code == "40003") {//\u8fd9\u91cc\u4ee3\u8868token\u5931\u6548\u548ctoken\u9519\u8bef\n        window.location.href = "/";\n      } else {\n        return response;\n      }\n    },\n    (error) => {\n      return Promise.reject(error);\n    }\n  );\n\n  const api = {\n    get(url, data) {\n      instance.defaults.headers.common["access_token"] = LocalStorage.get(\n        "access_token"\n      );\n      instance.defaults.headers.common["refresh_token"] = LocalStorage.get(\n        "refresh_token"\n      );\n      return instance.get(url, { params: data });\n    },\n    post(url, data) {\n      instance.defaults.headers.common["access_token"] = LocalStorage.get(\n        "access_token"\n      );\n      instance.defaults.headers.common["refresh_token"] = LocalStorage.get(\n        "refresh_token"\n      );\n      //post\u63a5\u53e3\u5c01\u88c5\n      return instance.post(url, qs.stringify(data));\n    },\n  };\n\n  export { api };',lang:"js"})))}));n["default"]=e=>{var n=o.useContext(s.context),t=n.demos;return o.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&s.AnchorLink.scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),o.createElement(a,{demos:t})}}}]);